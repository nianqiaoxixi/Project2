# 编译大作业第二部分报告

##### 王雯琦 1700012879 王晨茜 1700013013 张佳琪 1700012888

### 1.设计思路

在本次project2的具体实现过程中，分为重写IRMutator和重写IRPrinter两部分，其余部分基本与project1中实现的方法一致，只有部分细节地方的修改。

在重写IRMutator中，主要完成等式左侧结点与被求导结点的对调，以及下标和一些特殊情况的处理（如乘方和数组降维处理），返回新的IR结点。

在重写IRPrinter过程中，继承project1中已实现的IRPrinter并进行部分重写，主要完成等式中常数项的处理，以生成最终的求导代码。

### 2.实现流程

#### 2.1重写IRMutator

- 对乘方的特殊处理：

  由于乘方的存在，单纯对调结点并调整下标并无法完成对其求导，故在Binary结点对其进行特殊处理，如果当前为被求导变量的乘方运算，则生成其相加的结点并于等式左侧结点相乘，例如B = A * A，则会先生成A + A结点，并返回dB * (A + A)结点。

- 对于case8类型的特殊处理：

  观察case8可以看出，它所做的为将二维数组拉伸为一维数组，故可以不对其下标做处理，而对循环的次数做处理，同样可以达到目的。即将循环的次数乘二维数组的行向量长度，即可完成操作。

#### 2.2重写IRPrinter

增加以下属性便于常数的处理：

- op_flag：整型变量，初始化为-1，若当前运算符为Add或Sub，该变量为0；若当前运算符为Mul或Div或Mod，该变量为1；若当前运算符为And或Or，该变量为2。
- index_flag：布尔型变量，初始化为false，若当前表达式的计算在下标内或选择语句时，该变量为true。

主要对一下几个结点进行重写：

- Var

  在处理Var的下标时，将index_flag设为true，当处理结束时，将index_flag设为原始值。

- Select

  在处理Select结点之前，将index_flag设为true，当处理结束时，将index_flag设为原始值。

- Binary

  对于不同的运算符，对op_flag进行不同的赋值，并在函数返回之前，将op_flag置为-1

- IntImm、UIntImm、FloatImm

  若op_flag为0且index_flag为false（即当前运算符为Add或Sub且运算不在下标或Select结点），则输出0.0，否则输出原值

#### 2.3可行性与正确性解释

下面以case1为例解释该技术的可行性与正确性。

```json
{
    "name": "grad_case1",
    "ins": ["A", "B"],
    "outs": ["C"],
    "data_type": "float",
    "kernel": "C<4, 16>[i, j] = A<4, 16>[i, j] * B<4, 16>[i, j] + 1.0;",
    "grad_to": ["A"]
}
```

由上图可以看出，原始表达式为：$$C[i][j] = A[i][j]*B[i][j] + 1.0$$，求导对象为A，根据上述技术，应将等式左侧的C结点与等式右侧的A结点交换，并对其的名称进行相应的变化，此时生成的表达式应为：$$dA[i][j] = dC[i][j]*B[i][j] + 1.0$$，由于在求导过程中，原始表达式中加或减的常数求导后为0，故经过IRPrinter的处理，该表达式中的1.0变为0.0输出，生成表达式：$$dA[i][j] = dC[i][j]*B[i][j] + 0.0$$。

故最终生成的自动求导代码为：

```c++
#include "../run2.h"

void grad_case1(float (&B)[4][16], float (&dC)[4][16], float (&dA) [4][16]) {
  for (int i = 0; i < 4; ++i) {
    for (int j = 0; j < 16; ++j) {
      float temp = 0;
      temp = (temp + (dC[i][j] * B[i][j] + 0.0));
      dA[i][j] = temp;
    }
  }
}
```

### 3.实验结果

通过最终程序的运行，可以看出，10个例子均可正确通过。

### 4.成员分工

重写IRMutator：王晨茜、王雯琦、张佳琪

重写IRPrinter：王雯琦

### 5.总结

